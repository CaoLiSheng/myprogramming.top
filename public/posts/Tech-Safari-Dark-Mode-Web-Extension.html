<!DOCTYPE html><html lang="cn-zh"><head><meta charset="UTF-8" /><meta http-equiv="pragma" content="no-cache" /><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Safari Dark Mode Web Extension</title><script> var _hmt = _hmt || []; (function () { var hm = document.createElement('script'); hm.src = 'https://hm.baidu.com/hm.js?f402a68d651d46513a3688a8d07eb93c'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(hm, s); })(); </script><link rel="stylesheet" type="text/css" href="github-colors.9bfef90d8f.css" /></head><body theme="Light" class="snapshot"><div id="main"><article class="markdown-body hidden"><h1>Safari Dark Mode Web Extension</h1><h6 class="date-tag"><code> ~-~> 2020-12-06</code></h6><h2 id="目前对各网站的支持情况">目前对各网站的支持情况</h2><table><thead><tr><th style="text-align:left;">Web Site</th><th style="text-align:right;">Supported</th></tr></thead><tbody><tr><td style="text-align:left;">baidu</td><td style="text-align:right;">√</td></tr><tr><td style="text-align:left;">bing</td><td style="text-align:right;">√</td></tr><tr><td style="text-align:left;">google</td><td style="text-align:right;">√</td></tr><tr><td style="text-align:left;">github</td><td style="text-align:right;">√</td></tr><tr><td style="text-align:left;">gitee</td><td style="text-align:right;">√</td></tr><tr><td style="text-align:left;">stackoverflow</td><td style="text-align:right;">√</td></tr><tr><td style="text-align:left;">apple</td><td style="text-align:right;">X</td></tr></tbody></table><h2 id="开发过程">开发过程</h2><blockquote><p><a href="https://devstreaming-cdn.apple.com/videos/wwdc/2020/10665/3/C174BFAC-4EEB-41C6-9019-4386F9E18CD5/master.m3u8">官网视频教程</a></p></blockquote><ol><li>看完教程之后，我先创建了一份 cn_zh 的本地化文件，成功改掉了默认的插件名称。</li><li>接着设计总体架构：<ul><li>background.js 维护当前是否需要反转颜色（没错，我只是在反转颜色），因为 swift 经验比较少，又是给自己用，就没有纠结给 native 通信。</li><li>content.js 首先与 background.js 通信，在启用反转的情况下，立刻反转页面颜色。具体的反转方法后面细说。</li><li>popup.js 第一步也是与 background.js 通信，获取启用状态并以合适的 UI 显示出来；同时，通过一个按钮来切换启用状态，并通过 background.js 间接地调用 content.js 里反转的逻辑。</li></ul></li><li>最终设计反转算法。经历了多次迭代，以及将单文件代码拆分模块，最终设计了两级反转算法（在默认级别失效后，启动降级操作）：<ul><li>默认级别是通过 <code>document.styleSheets</code> 更改 <code>CSSStyleDeclaration</code> 当中的颜色部分（注：由于 <code>CSS3</code> 变量的存在，所以这里的更改是针对属性值的）。</li><li>降级后，深度优先后序遍历页面所有节点，通过计算 <code>getComputedStyle</code> 获取 <code>CSSStyleDeclaration</code>，将 <code>color</code>, <code>background-color</code> 反转后，写入元素内联 <code>style</code> 属性（注：没错，既然是降级，边框和渐变色就顾不上了，而且伪元素本来也遍历不到）。</li><li>降级的条件：首先遇到不合法的 <code>CSSStyleSheet</code> 时，会根据 <code>href</code> 用跨域方式重试。如果此方法依然不行，就采取降级方式。</li></ul></li></ol><h2 id="发布过程">发布过程</h2><blockquote><p>因为穷，玩不起。既没有苹果手机，也交不起会费。</p></blockquote><p><img alt="因为穷，玩不起" src="../resources/Safari-Dark-Mode-Web-Extension/lack-of-money.png" title="因为穷，玩不起" /></p><p>只好在最后线上<a href="https://gitee.com/yx1991/dark-mode-web-extension">开源链接</a>，希望有人能一起研究、改进。</p><br /><br /><hr /><br /><div class="comments"><a href="mailto:954382491@qq.com?subject=评价「Safari Dark Mode Web Extension」">发邮件~来评价~一下吧</a><h6 class="tip">⚠️ 请先安装一款邮件软件（部分浏览器可能不支持，请使用设备默认浏览器打开本页面）</h6></div><br /></article></div><script type="application/javascript" src="template.7c2a022c86.js"></script></body></html>