<!DOCTYPE html>
<html lang="cn-zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2020年里程碑 - 1</title>
    <script>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement('script');
        hm.src = 'https://hm.baidu.com/hm.js?f402a68d651d46513a3688a8d07eb93c';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <style>
      html,body {color: black;}*:not('#mkdbuttons') {margin: 0;padding: 0;}.markdown-body {font: 15px helvetica, arial, freesans, clean, sans-serif;-webkit-font-smoothing: antialiased;line-height: 1.7;padding: 3px;background: #fff;border-radius: 3px;-moz-border-radius: 3px;-webkit-border-radius: 3px;}p {margin: 1em 0;}a {color: #4183c4;text-decoration: none;}.markdown-body {background-color: #fff;padding: 30px;margin: 15px;font-size: 15px;line-height: 1.6;}.markdown-body > *:first-child {margin-top: 0 !important;}.markdown-body > *:last-child {margin-bottom: 0 !important;}h1,h2,h3,h4,h5,h6 {font-weight: 700;line-height: 1.7;cursor: text;position: relative;margin: 1em 0 15px;padding: 0;}h1 {font-size: 2.5em;border-bottom: 1px solid #ddd;}h2 {font-size: 2em;border-bottom: 1px solid #eee;}h3 {font-size: 1.5em;}h4 {font-size: 1.2em;}h5 {font-size: 1em;}h6 {color: #777;font-size: 1em;}p,blockquote,table,pre {margin: 15px 0;}ul {padding-left: 30px;}ol {padding-left: 30px;}ol li ul:first-of-type {margin-top: 0px;}hr {background: transparenturl(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC)repeat-x 0 0;border: 0 none;color: #ccc;height: 4px;margin: 15px 0;padding: 0;}.markdown-body > h2:first-child {margin-top: 0;padding-top: 0;}.markdown-body > h1:first-child {margin-top: 0;padding-top: 0;}.markdown-body > h1:first-child + h2 {margin-top: 0;padding-top: 0;}.markdown-body > h3:first-child,.markdown-body > h4:first-child,.markdown-body > h5:first-child,.markdown-body > h6:first-child {margin-top: 0;padding-top: 0;}a:first-child h1,a:first-child h2,a:first-child h3,a:first-child h4,a:first-child h5,a:first-child h6 {margin-top: 0;padding-top: 0;}h1 + p,h2 + p,h3 + p,h4 + p,h5 + p,h6 + p,ul li > :first-child,ol li > :first-child {margin-top: 0;}dl {padding: 0;}dl dt {font-size: 14px;font-weight: bold;font-style: italic;padding: 0;margin: 15px 0 5px;}dl dt:first-child {padding: 0;}dl dt > :first-child {margin-top: 0;}dl dt > :last-child {margin-bottom: 0;}dl dd {margin: 0 0 15px;padding: 0 15px;}dl dd > :first-child {margin-top: 0;}dl dd > :last-child {margin-bottom: 0;}blockquote {border-left: 4px solid #ddd;padding: 0 15px;color: #777;}blockquote > :first-child {margin-top: 0;}blockquote > :last-child {margin-bottom: 0;}table {border-collapse: collapse;border-spacing: 0;font-size: 100%;font: inherit;}table th {font-weight: bold;border: 1px solid #ccc;padding: 6px 13px;}table td {border: 1px solid #ccc;padding: 6px 13px;}table tr {border-top: 1px solid #ccc;background-color: #fff;}table tr:nth-child(2n) {background-color: #f8f8f8;}img {max-width: 100%;}code,tt {margin: 0 2px;padding: 0 5px;white-space: nowrap;border: 1px solid #eaeaea;background-color: #f8f8f8;border-radius: 3px;font-family: Consolas, 'Liberation Mono', Courier, monospace;font-size: 12px;color: #333333;}pre > code {margin: 0;padding: 0;white-space: pre;border: none;background: transparent;}.highlight pre {background-color: #f8f8f8;border: 1px solid #ccc;font-size: 13px;line-height: 19px;overflow: auto;padding: 6px 10px;border-radius: 3px;}pre {background-color: #f8f8f8;border: 1px solid #ccc;font-size: 14px;line-height: 19px;overflow: auto;padding: 6px 10px;border-radius: 3px;margin: 26px 0;}pre code,pre tt {background-color: transparent;border: none;}.poetry pre {font-family: Georgia, Garamond, serif !important;font-style: italic;font-size: 110% !important;line-height: 1.6em;display: block;margin-left: 1em;}.poetry pre code {font-family: Georgia, Garamond, serif !important;word-break: break-all;word-break: break-word;-webkit-hyphens: auto;-moz-hyphens: auto;hyphens: auto;white-space: pre-wrap;}sup,sub,a.footnote {font-size: 1.4ex;height: 0;line-height: 1;vertical-align: super;position: relative;}sub {vertical-align: sub;top: -1px;}@media print {body {background: #fff;}img,pre,blockquote,table,figure {page-break-inside: avoid;}.markdown-body {background: #fff;border: none;}pre code {overflow: visible;}}@media screen {body.inverted {color: #eee !important;border-color: #555;box-shadow: none;}.inverted .markdown-body,.inverted hr,.inverted p,.inverted td,.inverted li,.inverted h1,.inverted h2,.inverted h3,.inverted h4,.inverted h5,.inverted h6,.inverted th,.inverted .math,.inverted caption,.inverted dd,.inverted dt,.inverted blockquote {color: #eee !important;border-color: #555;box-shadow: none;}.inverted td,.inverted th {background: #333;}.inverted pre,.inverted code,.inverted tt {background: #eeeeee !important;color: #111;}.inverted h2 {border-color: #555555;}.inverted hr {border-color: #777;border-width: 1px !important;}::selection {background: rgba(157, 193, 200, 0.5);}h1::selection {background-color: rgba(45, 156, 208, 0.3);}h2::selection {background-color: rgba(90, 182, 224, 0.3);}h3::selection,h4::selection,h5::selection,h6::selection,li::selection,ol::selection {background-color: rgba(133, 201, 232, 0.3);}code::selection {background-color: rgba(0, 0, 0, 0.7);color: #eeeeee;}code span::selection {background-color: rgba(0, 0, 0, 0.7) !important;color: #eeeeee !important;}a::selection {background-color: rgba(255, 230, 102, 0.2);}.inverted a::selection {background-color: rgba(255, 230, 102, 0.6);}td::selection,th::selection,caption::selection {background-color: rgba(180, 237, 95, 0.5);}.inverted {background: #0b2531;background: #252a2a;}.inverted .markdown-body {background: #252a2a;}.inverted a {color: #acd1d5;}}.highlight .c {color: #998;font-style: italic;}.highlight .err {color: #a61717;background-color: #e3d2d2;}.highlight .k,.highlight .o {font-weight: bold;}.highlight .cm {color: #998;font-style: italic;}.highlight .cp {color: #999;font-weight: bold;}.highlight .c1 {color: #998;font-style: italic;}.highlight .cs {color: #999;font-weight: bold;font-style: italic;}.highlight .gd {color: #000;background-color: #fdd;}.highlight .gd .x {color: #000;background-color: #faa;}.highlight .ge {font-style: italic;}.highlight .gr {color: #a00;}.highlight .gh {color: #999;}.highlight .gi {color: #000;background-color: #dfd;}.highlight .gi .x {color: #000;background-color: #afa;}.highlight .go {color: #888;}.highlight .gp {color: #555;}.highlight .gs {font-weight: bold;}.highlight .gu {color: #800080;font-weight: bold;}.highlight .gt {color: #a00;}.highlight .kc,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr {font-weight: bold;}.highlight .kt {color: #458;font-weight: bold;}.highlight .m {color: #099;}.highlight .s {color: #d14;}.highlight .na {color: #008080;}.highlight .nb {color: #0086b3;}.highlight .nc {color: #458;font-weight: bold;}.highlight .no {color: #008080;}.highlight .ni {color: #800080;}.highlight .ne,.highlight .nf {color: #900;font-weight: bold;}.highlight .nn {color: #555;}.highlight .nt {color: #000080;}.highlight .nv {color: #008080;}.highlight .ow {font-weight: bold;}.highlight .w {color: #bbb;}.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo {color: #099;}.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx {color: #d14;}.highlight .sr {color: #009926;}.highlight .s1 {color: #d14;}.highlight .ss {color: #990073;}.highlight .bp {color: #999;}.highlight .vc,.highlight .vg,.highlight .vi {color: #008080;}.highlight .il {color: #099;}.highlight .gc {color: #999;background-color: #eaf2f5;}.type-csharp .highlight .k,.type-csharp .highlight .kt {color: #00f;}.type-csharp .highlight .nf {color: #000;font-weight: normal;}.type-csharp .highlight .nc {color: #2b91af;}.type-csharp .highlight .nn {color: #000;}.type-csharp .highlight .s,.type-csharp .highlight .sc {color: #a31515;}body.dark .markdown-body {background: transparent !important;box-shadow: none !important;}::-webkit-scrollbar {width: 3pt;height: 3pt;}::-webkit-scrollbar-track {background: #ddd;border-radius: 9pt;}::-webkit-scrollbar-corner {background: #ddd;}::-webkit-scrollbar-thumb {background: #999;border-radius: 9pt;}::-webkit-scrollbar-thumb:window-inactive {background: #aaa;}body {display: flex;flex-direction: row;justify-content: center;align-items: flex-start;border: none;padding: 0;}.markdown-body {box-sizing: border-box;margin: 1rem auto;min-width: 200px;max-width: 980px;width: 100%;padding: 45px;}.markdown-body:not(.snapshot) {border-radius: 6px;border: solid 1px gray;box-shadow: 0 0 5px 0 gray;}.markdown-body.hidden {display: none;}@media (max-width: 750px) {.markdown-body {margin: 1rem;padding: 15px;}}.markdown-body ul,.markdown-body ol,.markdown-body dl {list-style-position: inside;}.markdown-body pre {overflow: auto;}.markdown-body pre code {padding: 0;border: none;background: transparent;}.markdown-body figcaption {text-align: center;}
    </style>
  </head>
  <body>
    <article class="markdown-body snapshot">
      <h1>2020年里程碑 - 1</h1>
      <h2 id="">前言</h2>
<blockquote>
  <p>这几天一直在等通知去公证处取房本，所以暂时不能离开昆明。边写代码、边玩《暗黑 3》过了两周，终于完成了类似 Hexo 的博客工具开发。现在在这里树立一个里程碑，也顺便总结一下这个项目。</p>
</blockquote>
<h2 id="-1">第一部分</h2>
<p>首先是代码打包配置部分。最近在抖音上看到又出了一个新的打包神器，但是我并没有去调研，所以依旧使用<code>webpack</code>。</p>
<p>使用<code>babel-loader</code>把最新规范下的模块化代码转化为 es5 规范输出，这里有三份配置。</p>
<ol>
<li>处理 markdown 文章的 NodeJS 程序</li>
<li>骨架网站的开发版配置，就是多了 react-hot-reload</li>
<li>骨架网站的线上版配置</li>
</ol>
<p>提到<strong>骨架网站</strong>，我实在想不出什么名字来命名，就是 Hexo 里的主题。而我感觉文章像血肉，而这个主题像骨架，整体来看就是我的博客。骨架网站中另需处理 CSS3 样式和各类资源文件，所以需要<code>style-loader</code>、<code>css-loader</code>、<code>sass-loader</code>、<code>url-loader</code>这四个加载器。</p>
<blockquote>
  <p>这里就不得不提到<strong>url-loader</strong>和<strong>file-loader</strong>了。对于图片来说，前者默认将文件转化成 Base64 格式写在最后的打包后模块中。可以通过参数设置，按照文件大小分别处理，小于 limit 参数的同上处理；而反之，其行为与后者相同，即把资源文件放到最终打包的目标资源文件夹中。</p>
</blockquote>
<h2 id="-2">第二部分</h2>
<p>由于项目的特殊性，开发时要启动多个进程（其实，很多这样的情况）。我在 2019 年的时候，是使用 tmux 方案，即写一段<code>shell</code>脚本，启动 tmux 进程、切分终端、在对应终端启动特定进程。今年发现了一个新方法：</p>
<pre><code class="shell language-shell">concurrently --handle-input 'nodemon --exec \"node ./build/gen.prod.js &gt; log.txt\"' 'serve -C ./public/' 'webpack-dev-server --config=cfg/webpack/dev.js'
</code></pre>
<p>如上所示，<code>concurrently</code>命令非常直观的接收若干个字符串参数，每一个都说是并行的一个程序，<code>--handle-input</code>参数让我可以在任何时间改变任何一个程序的状态。简单说，我同时运行了一个 markdown 转 html 程序、一个访问这些 html 文件的简单 http 服务器以及骨架网站的开发状态服务器。</p>
<p>其中，<code>nodemon</code>的作用是启动后台监听进程，与<code>concurrently</code>配合可以在任何时间通过<code>concurrently --handle-input</code>生成最新 html 文件。</p>
<h2 id="-3">第三部分</h2>
<p>那么接下来总结由 markdown 转化为 html 部分。主要由三部分组成：一小段 NodeJS 程序、一个模版、一些 CSS 样式表。程序部分仅使用到<code>fs-extra</code>、<code>moment</code>、<code>showdown</code>三个外部包。首先，创建或者清空输出文件夹。</p>
<pre><code class="javascript language-javascript">import fs from 'fs-extra';

...

fs.mkdirSync(outDir, { recursive: true });
fs.emptyDirSync(outDir);
</code></pre>
<blockquote>
  <p>这里需要说明输入、输出文件夹内结构。输入文件夹内仅包含 markdown 文件以及可能存在的同名的一个文件夹，里面存放对应文章的资源。输出文件夹也很简单，包含所有 CSS 样式表、生成的 html 文件、所有的与文章对应的资源文件夹、数据库文件（JSON 格式）。</p>
</blockquote>
<p>所以，拷贝 CSS 样式表文件与拷贝资源文件，一气呵成。</p>
<pre><code class="typescript language-typescript">import styles from '@tpl/styles';

...

// Copy CSS Assets
Object.keys(styles).forEach((stylesheet) =&gt; {
  const { src, desc } = styles[stylesheet];
  fs.copySync(path.join(process.cwd(), ...src), path.join(outDir, desc));
});
console.log('CSS Assets Copied');

--- @tpl/styles.ts

export default {
  github: { // 样式表名称，后面会用到
    src: ['src', 'tpl', 'style-source', 'github.css'], // 源文件所在路径，本来源文件是在node_modules里的，后来随着我发现越来越多的样式表就拷贝到了src里面
    desc: 'github.css', // 在输出文件夹里的文件名
  }
};
</code></pre>
<p>接着，定义数据库结构。</p>
<pre><code class="typescript language-typescript">// recursive numberic key object
export interface RNK {
  [key: number]: RNK | string[];
}

export interface PublicMeta {
  date: string;
  tags: string[];
}

export interface Schema {
  metas: { [key: string]: PublicMeta }; // 元数据
  sortedPosts: string[]; // 按日期倒排大列表
  dateCategories: RNK; // 按日期（年、月、日）逐级分类
  tagCategories: { [key: string]: string[] }; // 按标签分类
}
</code></pre>
<p>最后，解析 markdown 文件并生成数据库文件和 html 文件，大致上就是这么三个步骤。解析的手段主要是正则表达式，写入数据库需要用到<code>moment</code>包，生成 html 由<code>showdown</code>全权负责。这里面最省事的就是生成 html。</p>
<pre><code class="typescript language-typescript">import showdown from 'showdown';

// Construct Converter
const converter = new showdown.Converter();

...

const body = converter.makeHtml(content);
</code></pre>
<p>对头部的解析需要两组正则表达式（hhh 反正我是没有一次搞定）。</p>
<pre><code class="text language-text">头部大致长以下这个样子：
---
style: amblin
title: 2020 年里程碑 - 1
date: 2020-08-09 16:14:00
tags:
  - 里程碑
  - 提升计划
  - 2020
---
</code></pre>
<pre><code class="typescript language-typescript">const matches = fileContent.match(
  /^---\nstyle: (.*?)\ntitle: (.*?)\ndate: (.*?)\n(?:tags:.*?\n([\s\S]*?))?---\n([\s\S]*)$/
);

if (!matches) throw new Error(`文章[ ${fileName} ]头部信息解析出现错误！`);

const [stylesheet, title, date, tags, content] = matches.slice(1);
</code></pre>
<p>如上代码所示，stylesheet 的值就是之前提到的样式表名称，必须是存在的名称，否则没有华丽的样式可言。tags 就是初步解析出来的标签相关部分，需要进一步使用第二个正则表达式进行处理。</p>
<pre><code class="typescript language-typescript">const tagsRe = /- (.*?)\n/g;
const parsedTags = [];
if (tags) {
  let tempTag;
  while ((tempTag = tagsRe.exec(tags))) {
    parsedTags.push(tempTag[1]);
  }
}
</code></pre>
<p>按照模版生成 html 文件仅需要几处字符串替换即可，我思考了很久也没有找到合适的模版关键字语法。这里就是耦合比较重的地方了。如下，大部分情况使用单标签方式，CSS 中使用区间注解方式，主要目的是为了让编辑器 lint 顺利通过（hhh 反正我就是不喜欢 JSP）。</p>
<pre><code class="typescript language-typescript">fs.writeFileSync(
  outFilePath,
  tplContent
    .replace('&lt;title /&gt;', title)
    .replace('&lt;stylesheet /&gt;', './' + styles[stylesheet].desc)
    .replace('&lt;body_title /&gt;', title)
    .replace('/* body_padding_0 */', getBodyPadding0(stylesheet))
    .replace('/* body_padding_1 */', getBodyPadding1(stylesheet))
    .replace('&lt;body /&gt;', body)
);
</code></pre>
<p>模版也起着关键作用，首先说明在生成 html 文件这个过程中发挥的作用，在之后还有别的作用。自定义的网页标题、样式、文章标题并且把文章内容和标题组合放到一个区域下进行管理，并且可以对不同样式表中可能存在的 bug 进行统一的修复。</p>
<pre><code class="html language-html">&lt;article class="markdown-body"&gt;
  &lt;h1&gt;&lt;body_title /&gt;&lt;/h1&gt;
  &lt;body /&gt;
&lt;/article&gt;
</code></pre>
<h2 id="-4">第四部分</h2>
<p>那么最后总结下骨架网站研发中用到的技术栈<code>react + typescript</code>、<code>react-router</code>，并没有采用<code>redux全家桶</code>，而是使用 v16 自带的<code>createContext</code> API。<code>HTML5+CSS3</code>就像是与身俱来的技能一样，总能船到桥头自然直。<code>typescript</code>在今年是爆发的一年，或者说普及的一年；虽然我现在自由职业了，但是也要跟上时代的步伐。说来也有趣，最初是通过<code>AngularJS</code>接触的，当时并没有太多的关注；如果不是这次写装饰器卡住了，还真的完全小看了它。</p>
<p>我对<code>createContext</code> API 的使用方式是这样的。如下方代码所示，用到高阶组件的概念给用到上下文的组件注入数据或者操作（对于改变上下文的操作要特别注意其调用的时机，防止死循环）。<code>HOCDecrator</code>是<code>typescript</code>语法中装饰器的一种情况，这种操作多少算是取巧的做法（在下方第二段代码中）。</p>
<pre><code class="typescript language-typescript">import React, { createContext, ComponentType, Component } from 'react';

export interface I_CTX {}

const { Provider, Consumer } = createContext({});

export function inject(): HOCDecrator&lt;{ ctx?: I_CTX }&gt; {
  return &lt;P extends { ctx?: I_CTX }&gt;(WrapperedComponent: ComponentType&lt;P&gt;) =&gt;
    class extends Component&lt;P&gt; {
      public render() {
        return (
          &lt;Consumer&gt;
            {(ctx: I_CTX) =&gt; &lt;WrappedComponent {...this.props} ctx={ctx} /&gt;}
          &lt;/Consumer&gt;
        );
      }
    };
}

export function withProvider(): HOCDecrator&lt;{ ctx?: I_CTX }&gt; {
  return &lt;P extends { ctx?: I_CTX }&gt;(WrapperedComponent: ComponentType&lt;P&gt;) =&gt;
    class extends Component&lt;P, I_CTX&gt; {
      state = {};

      public render() {
        return (
          &lt;Provider value={this.state}&gt;
            &lt;WrappedComponent {...this.props} ctx={this.state} /&gt;
          &lt;/Provider&gt;
        );
      }
    };
}
</code></pre>
<pre><code class="typescript language-typescript">export type HOCDecrator&lt;InjectProps&gt; = &lt;Props extends InjectProps&gt;(
  Component: React.ComponentType&lt;Props&gt;
) =&gt; void;
</code></pre>
<p>有一次刷新文章详情页的时候，发现文章地址竟然被请求了三次。经过一番思考，发觉是<code>Provider</code>太多了。所以，在用到<code>Provider</code>的组件里，仅仅是骨架代码，<code>shouldComponentUpdate</code>总返回<code>false</code>，相应数据变化的组件都利用<code>Consumer</code>注入。</p>
<h2 id="-5">第五部分</h2>
<p>这一部分是后补的内容，总结开发手机版时的相关内容。目前，手机版与 PC 版的差别不大，仅体现在左上角部分做的一个抽屉。UI 的切换使用 CSS 媒体查询，如下。</p>
<pre><code class="css language-css">.title-bar nav ul.mobile-only {
  display: none;
}

@media (max-width: 750px) {
  .title-bar nav ul:not(.mobile-compatible) {
    display: none;
  }

  .title-bar nav ul.mobile-only {
    display: flex;
  }
}

// .mobile-only 就是抽屉部分
// .mobile-compatible 就是手机版和PC版都有的部分
</code></pre>
<p>抽屉有一个特点就是，打开后无论接下来点哪里，都会收起。我将抽屉打开后点击的区域分为三类，触发打开的区域（仅切换了图标）、其它区域但不是 <code>iframe</code>，<code>iframe</code>（这个其实是本站特有，在文章详情页）。</p>
<p>对于情况一，这个区域的逻辑永远是 <code>toggle</code>。对于情况二，可以在 <code>body</code> 上监听 <code>click</code> 事件、并判断没有落入情况一所在区域，总是收起抽屉即可。对于情况三，逻辑同样是收起抽屉，只是实现起来需要用到 <code>postMessage</code> API。</p>
<pre><code class="typescript language-typescript">document.body.addEventListener('click', () =&gt; {
  window.top.postMessage('iframe.detail clicked', 'http://yx1991.gitee.io');
});

window.top.addEventListener(
  'message',
  (event: MessageEvent) =&gt; 'iframe.detail clicked' === event.data &amp;&amp; close() // 收起抽屉
);
</code></pre>
<h2 id="-6">结语</h2>
<blockquote>
  <p>接下来要抓紧时间去完成剩余的<a href="post:2020-plan" rel="noopener noreferrer" target="_blank">计划</a>咯!</p>
</blockquote>
    </article>
    <script>
      window.templateConfigs = {
        __origin__: 'http://yx1991.gitee.io',
        __site_root__: 'http://yx1991.gitee.io/blog',
      };

      !function(t){var e={};function o(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=t,o.c=e,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/",o(o.s="./src/template/basic/index.ts")}({"./src/template/basic/index.ts":function(t,e){if(window.templateConfigs){var o,n=window.templateConfigs,r=n.__origin__,i=n.__site_root__;if(window.top===window&&(location.href="".concat(i,"/#/post").concat(location.pathname)),window.addEventListener("message",(function(t){var e;"show-time"===t.data&&(null===(e=document.querySelector("article.markdown-body.hidden"))||void 0===e||e.classList.remove("hidden"))})),window.top.postMessage("is-it-time-to-show",r),"#snapshot"!==location.hash)null===(o=document.querySelector("article.markdown-body.snapshot"))||void 0===o||o.classList.remove("snapshot");document.body.addEventListener("click",(function(){window.top.postMessage("iframe.detail clicked",r)})),document.querySelectorAll("a").forEach((function(t){var e=t.getAttribute("href");(null==e?void 0:e.startsWith("post:"))&&(t.setAttribute("href","".concat(i,"/#/").concat(e.replace(":","/"))),t.setAttribute("target","_top"))}))}}});
    </script>
  </body>
</html>
